# AI-Powered DevOps Planning & Implementation Pipeline
# Triggered via REST API from Power Automate/Azure Function when work item state changes
#
# This is the main orchestrator - actual logic is in templates/

trigger: none # Manual/API trigger only

parameters:
  - name: workItemId
    type: string
    displayName: 'Work Item ID'
  - name: workflowType
    type: string
    displayName: 'Workflow Type'
    values:
      - quick-fix
      - plan
      - implement
  - name: azureDevOpsOrg
    type: string
    displayName: 'Azure DevOps Organization'
  - name: azureDevOpsProject
    type: string
    displayName: 'Azure DevOps Project Name'
  - name: githubOwner
    type: string
    displayName: 'GitHub Repository Owner'
  - name: targetRepo
    type: string
    displayName: 'Target Repository Name'
  - name: targetBranch
    type: string
    displayName: 'Target Branch for PR'
    default: 'main'

# Import shared variables
variables:
  - template: templates/variables.yml

pool:
  vmImage: 'ubuntu-latest'

stages:
  - stage: AIWorkflow
    displayName: 'AI ${{ parameters.workflowType }} Workflow'
    jobs:
      - job: ExecuteWorkflow
        displayName: 'Execute ${{ parameters.workflowType }}'
        timeoutInMinutes: 60
        steps:
          # ============================================
          # PHASE 1: CHECKOUT REPOSITORIES
          # ============================================
          - template: templates/setup/checkout.yml
            parameters:
              targetRepo: ${{ parameters.targetRepo }}
              githubOwner: ${{ parameters.githubOwner }}

          # ============================================
          # PHASE 2: SETUP ENVIRONMENT
          # ============================================
          - template: templates/setup/environment.yml

          # ============================================
          # PHASE 3: FETCH WORK ITEM CONTEXT
          # ============================================
          - template: templates/setup/work-item.yml
            parameters:
              workItemId: ${{ parameters.workItemId }}
              azureDevOpsOrg: ${{ parameters.azureDevOpsOrg }}
              azureDevOpsProject: ${{ parameters.azureDevOpsProject }}

          # ============================================
          # PHASE 3.5: CLAUDE CODE DIAGNOSTICS
          # ============================================
          - template: templates/setup/diagnostics.yml
            parameters:
              workflowType: ${{ parameters.workflowType }}

          # ============================================
          # PHASE 4: RUN CLAUDE CODE (Workflow-Specific)
          # ============================================

          # --- QUICK FIX WORKFLOW ---
          - ${{ if eq(parameters.workflowType, 'quick-fix') }}:
              - template: templates/workflows/quick-fix.yml

          # --- PLAN WORKFLOW ---
          - ${{ if eq(parameters.workflowType, 'plan') }}:
              - template: templates/workflows/plan.yml

          # --- IMPLEMENT WORKFLOW ---
          - ${{ if eq(parameters.workflowType, 'implement') }}:
              - template: templates/workflows/implement.yml
                parameters:
                  workItemId: ${{ parameters.workItemId }}
                  azureDevOpsOrg: ${{ parameters.azureDevOpsOrg }}
                  azureDevOpsProject: ${{ parameters.azureDevOpsProject }}

          # ============================================
          # PHASE 5: HANDLE OUTPUTS
          # ============================================

          # --- CREATE PR (quick-fix and implement) ---
          - ${{ if or(eq(parameters.workflowType, 'quick-fix'), eq(parameters.workflowType, 'implement')) }}:
              - template: templates/outputs/create-branch-pr.yml
                parameters:
                  workItemId: ${{ parameters.workItemId }}
                  workflowType: ${{ parameters.workflowType }}
                  targetRepo: ${{ parameters.targetRepo }}
                  azureDevOpsOrg: ${{ parameters.azureDevOpsOrg }}
                  azureDevOpsProject: ${{ parameters.azureDevOpsProject }}
                  githubOwner: ${{ parameters.githubOwner }}
                  targetBranch: ${{ parameters.targetBranch }}

          # --- ATTACH PLAN (plan workflow) ---
          - ${{ if eq(parameters.workflowType, 'plan') }}:
              - template: templates/outputs/attach-plan.yml
                parameters:
                  workItemId: ${{ parameters.workItemId }}
                  azureDevOpsOrg: ${{ parameters.azureDevOpsOrg }}
                  azureDevOpsProject: ${{ parameters.azureDevOpsProject }}

          # --- HANDLE BAIL OUT (quick-fix only) ---
          - ${{ if eq(parameters.workflowType, 'quick-fix') }}:
              - template: templates/outputs/handle-bailout.yml
                parameters:
                  workItemId: ${{ parameters.workItemId }}
                  azureDevOpsOrg: ${{ parameters.azureDevOpsOrg }}
                  azureDevOpsProject: ${{ parameters.azureDevOpsProject }}

          # ============================================
          # PHASE 6: CLEANUP & REPORTING
          # ============================================
          - template: templates/outputs/report.yml
            parameters:
              workflowType: ${{ parameters.workflowType }}
              workItemId: ${{ parameters.workItemId }}
              targetRepo: ${{ parameters.targetRepo }}
              azureDevOpsOrg: ${{ parameters.azureDevOpsOrg }}
              azureDevOpsProject: ${{ parameters.azureDevOpsProject }}
              githubOwner: ${{ parameters.githubOwner }}
