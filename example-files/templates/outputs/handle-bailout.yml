# Handle quick-fix bailout
# Adds a comment to the work item when quick-fix can't complete

parameters:
  - name: workItemId
    type: string
  - name: azureDevOpsOrg
    type: string
  - name: azureDevOpsProject
    type: string

steps:
  - script: |
      if [ "$(BAIL_OUT)" != "true" ]; then
        exit 0
      fi

      echo "Quick fix bailed out - adding comment to work item"

      CHANGED_BY=$(jq -r '.fields["System.ChangedBy"].uniqueName // "unknown"' $(Agent.TempDirectory)/work-item.json)

      COMMENT="AI QUICK FIX COULD NOT COMPLETE

      The issue appears to be too complex for an automated quick fix.

      Recommendation - Move this item to AI Plan status to generate a full implementation plan, or handle manually.

      Triggered by - ${CHANGED_BY}"

      chmod +x $(configRepoPath)/scripts/add-work-item-comment.sh
      $(configRepoPath)/scripts/add-work-item-comment.sh "${{ parameters.workItemId }}" "$COMMENT" "$(System.AccessToken)"
    displayName: 'Handle quick-fix bail out'
    condition: eq(variables['BAIL_OUT'], 'true')
    env:
      AZURE_DEVOPS_ORG: ${{ parameters.azureDevOpsOrg }}
      AZURE_DEVOPS_PROJECT: ${{ parameters.azureDevOpsProject }}
