# Create branch and pull request
# Used by quick-fix and implement workflows

parameters:
  - name: workItemId
    type: string
  - name: workflowType
    type: string
  - name: targetRepo
    type: string
  - name: azureDevOpsOrg
    type: string
  - name: azureDevOpsProject
    type: string
  - name: githubOwner
    type: string
  - name: targetBranch
    type: string

steps:
  # Create branch and push changes
  - script: |
      set -e  # Exit on any error

      # Skip if quick-fix bailed out
      if [ "$(BAIL_OUT)" == "true" ]; then
        echo "Skipping PR creation - quick fix bailed out"
        exit 0
      fi

      cd $(targetRepoPath)

      # Check if there are any changes
      if [ -z "$(git status --porcelain)" ]; then
        echo "##vso[task.logissue type=warning]No changes to commit"
        echo "##vso[task.setvariable variable=NO_CHANGES]true"
        exit 0
      fi

      # Create feature branch
      BRANCH_NAME="ai/${{ parameters.workItemId }}-${{ parameters.workflowType }}"
      echo "Creating branch: $BRANCH_NAME"

      # Check if branch exists locally or remotely and clean up
      git branch -D "$BRANCH_NAME" 2>/dev/null || true

      git checkout -b "$BRANCH_NAME"
      git add -A
      git commit -m "AI ${{ parameters.workflowType }}: Work Item #${{ parameters.workItemId }}"

      # Push with force to handle re-runs (safe for AI-generated branches)
      echo "Pushing branch to origin..."
      if ! git push --force-with-lease origin "$BRANCH_NAME" 2>&1; then
        echo "##vso[task.logissue type=error]Failed to push branch. Check GitHub PAT has 'Contents: Read and write' permission."
        echo "##vso[task.setvariable variable=PUSH_FAILED]true"
        exit 1
      fi

      echo "##vso[task.setvariable variable=BRANCH_NAME]$BRANCH_NAME"
      echo "##vso[task.setvariable variable=PUSH_FAILED]false"
      echo "Branch pushed successfully"
    displayName: 'Create branch and push changes'

  # Create pull request
  - script: |
      # Skip if bailed out, no changes, or push failed
      if [ "$(BAIL_OUT)" == "true" ]; then
        echo "Skipping PR creation - quick fix bailed out"
        exit 0
      fi

      if [ "$(NO_CHANGES)" == "true" ]; then
        echo "Skipping PR creation - no changes to commit"
        exit 0
      fi

      if [ "$(PUSH_FAILED)" == "true" ]; then
        echo "##vso[task.logissue type=error]Skipping PR creation - branch push failed"
        exit 1
      fi

      if [ -z "$(BRANCH_NAME)" ]; then
        echo "##vso[task.logissue type=error]Skipping PR creation - no branch name set (push may have failed)"
        exit 1
      fi

      chmod +x $(configRepoPath)/scripts/create-pr.sh
      chmod +x $(configRepoPath)/scripts/add-work-item-comment.sh
      $(configRepoPath)/scripts/create-pr.sh \
        "${{ parameters.workItemId }}" \
        "$(BRANCH_NAME)" \
        "${{ parameters.workflowType }}" \
        "$(GITHUB_PAT)" \
        "$(System.AccessToken)"
    displayName: 'Create Pull Request'
    condition: succeeded()
    env:
      GITHUB_PAT: $(GITHUB_PAT)
      GITHUB_OWNER: ${{ parameters.githubOwner }}
      GITHUB_REPO: ${{ parameters.targetRepo }}
      TARGET_BRANCH: ${{ parameters.targetBranch }}
      AZURE_DEVOPS_ORG: ${{ parameters.azureDevOpsOrg }}
      AZURE_DEVOPS_PROJECT: ${{ parameters.azureDevOpsProject }}
