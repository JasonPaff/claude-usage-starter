# Quick-fix workflow
# Attempts to fix trivial issues automatically, bails out if too complex

steps:
  - script: |
      set -e
      source $(Agent.TempDirectory)/work-item.env

      cd $(targetRepoPath)

      echo "Running Claude Code quick-fix..."
      echo "Issue: $WORK_ITEM_TITLE"

      # Build the full issue context
      ISSUE_CONTEXT="$WORK_ITEM_TITLE"
      if [ -n "$WORK_ITEM_DESCRIPTION" ]; then
        ISSUE_CONTEXT="$ISSUE_CONTEXT - Description: $WORK_ITEM_DESCRIPTION"
      fi
      if [ -n "$WORK_ITEM_ACCEPTANCE_CRITERIA" ]; then
        ISSUE_CONTEXT="$ISSUE_CONTEXT - Acceptance Criteria: $WORK_ITEM_ACCEPTANCE_CRITERIA"
      fi

      echo "Full context: $ISSUE_CONTEXT"

      # Run quick-fix command (timeout configured in variables.yml)
      # Use stream-json for real-time output, pipe through processor for milestone detection
      chmod +x $(configRepoPath)/scripts/stream-processor.sh
      timeout $(quickFixTimeout) claude --output-format stream-json --verbose --dangerously-skip-permissions \
        "/quick-fix \"$ISSUE_CONTEXT\"" \
        </dev/null 2>&1 | \
        tee $(Agent.TempDirectory)/raw-stream.jsonl | \
        $(configRepoPath)/scripts/stream-processor.sh | \
        tee $(Agent.TempDirectory)/claude-output.txt || true

      # Check if Claude bailed out (complexity check failed)
      if grep -q "Quick Fix Not Appropriate" $(Agent.TempDirectory)/claude-output.txt 2>/dev/null; then
        echo "##vso[task.logissue type=warning]Quick fix not appropriate - issue is too complex"
        echo "##vso[task.setvariable variable=BAIL_OUT]true"
      else
        echo "##vso[task.setvariable variable=BAIL_OUT]false"
      fi

      cat $(Agent.TempDirectory)/claude-output.txt
    displayName: 'Run Claude Code /quick-fix'
    env:
      ANTHROPIC_API_KEY: $(ANTHROPIC_API_KEY)
      CI: 'true'
      CLAUDE_CODE_DISABLE_NONESSENTIAL_TRAFFIC: '1'
